// Sound.c
// Runs on any TM4C123
// Sound assets based off the original Space Invaders 
// Import these constants into your SpaceInvaders.c for sounds!
// Jonathan Valvano
// 11/15/2021 
#include <stdint.h>
#include "tm4c123gh6pm.h"
#include "Sound.h"
#include "DAC.h"
#include "Timer0.h"

#define BusClock			80000000
#define SampleFreq		11025
#define rowclearLen		2068
int sound2play;

unsigned char rowclear[rowclearLen] = {32,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,32,31,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,31,31,31,31,32,31,31,32,32,31,32,32,32,32,32,31,31,31,31,31,32,31,31,31,31,32,32,31,32,32,32,32,31,32,31,32,32,31,32,31,31,32,32,32,32,32,32,32,32,31,31,32,32,32,31,31,31,32,32,32,32,32,31,31,32,31,32,32,31,31,31,32,32,32,32,32,32,32,32,32,32,32,31,32,32,31,31,31,31,32,32,32,31,31,31,31,32,32,32,31,31,31,31,31,31,31,31,31,31,31,32,32,32,32,31,31,31,32,32,31,32,31,31,31,31,31,31,31,31,32,32,32,32,32,32,31,31,31,31,31,32,32,32,32,31,31,31,32,32,32,32,31,31,32,31,31,31,31,32,32,32,32,32,32,31,31,31,31,31,31,32,31,32,32,31,32,31,31,31,31,31,32,32,32,32,31,31,31,31,31,32,31,32,32,32,32,31,31,31,31,31,32,32,32,32,32,32,32,32,31,32,31,31,31,31,31,32,32,32,32,31,31,32,32,32,32,31,31,32,31,32,31,31,31,31,31,32,31,32,31,31,32,32,32,32,32,31,31,31,32,32,32,32,31,31,31,31,32,32,32,31,31,31,32,32,32,31,31,31,31,32,32,32,32,31,32,32,32,32,31,31,31,31,32,32,32,31,31,32,32,32,32,32,31,31,31,32,32,32,31,31,31,32,32,32,32,32,32,32,32,32,33,32,32,32,32,31,32,31,30,30,31,31,31,31,31,32,29,29,32,32,34,33,29,28,28,31,33,32,31,28,29,30,33,34,34,32,31,31,31,32,32,32,32,32,32,32,32,32,32,33,33,33,33,32,32,32,32,32,31,31,31,32,32,32,32,32,32,32,32,32,31,31,31,31,31,32,32,32,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,32,32,31,31,31,31,31,31,32,31,31,31,31,31,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,31,31,31,31,32,32,32,31,31,31,31,32,32,32,31,31,31,31,32,31,31,31,31,31,32,31,31,31,32,32,32,31,31,31,31,32,32,32,32,32,31,31,32,32,32,32,31,31,31,31,32,32,32,32,32,32,31,31,31,31,32,31,32,31,32,31,31,31,31,32,32,32,31,31,31,31,31,32,32,31,31,31,31,31,32,32,32,32,32,31,31,31,32,32,32,32,31,31,31,32,32,32,32,31,31,31,31,32,32,32,31,31,31,32,32,32,32,32,32,31,31,31,31,32,32,32,31,31,31,32,32,32,31,31,31,31,32,32,32,31,31,31,31,32,32,31,31,31,31,31,32,32,32,31,31,31,31,31,32,32,32,31,31,31,31,31,32,32,31,31,31,32,32,32,32,32,31,31,32,32,32,31,31,31,31,31,31,31,31,32,32,32,32,32,31,31,32,31,31,31,31,32,31,32,32,31,31,31,31,31,31,32,32,32,31,31,31,31,32,32,31,32,31,32,32,32,31,31,31,32,32,32,32,31,31,32,32,32,32,31,31,32,31,32,32,32,31,31,31,32,32,32,32,31,31,31,32,32,32,31,31,31,31,31,32,32,31,31,31,31,31,32,32,31,31,31,31,31,32,32,32,32,31,31,31,32,32,32,32,31,31,31,32,32,32,32,31,32,32,32,32,32,31,31,31,32,32,32,32,32,31,31,31,32,32,32,31,31,31,31,32,32,32,31,31,32,32,32,32,31,31,31,32,32,32,31,31,32,32,32,32,31,31,31,32,32,32,32,32,31,31,31,31,31,31,32,32,32,32,31,32,32,32,32,31,31,31,32,32,32,32,31,31,31,31,31,31,31,31,32,32,32,32,31,31,31,32,32,32,31,31,31,31,32,32,32,31,31,31,32,32,32,32,31,31,31,32,32,32,32,31,31,32,31,32,32,31,31,31,32,32,32,32,31,31,31,32,32,32,31,31,31,32,32,32,32,31,31,31,32,32,32,32,31,31,31,32,32,32,31,31,31,31,32,32,32,32,31,31,31,31,32,32,31,31,31,31,32,32,31,31,31,31,32,32,32,32,31,31,31,32,32,31,31,31,31,32,32,32,32,31,31,31,32,32,32,32,32,31,31,32,32,32,32,32,31,31,31,31,32,32,32,32,31,32,31,31,31,32,32,32,32,31,31,31,31,32,31,31,31,31,31,31,32,32,32,32,31,31,31,32,32,32,32,31,31,31,32,32,32,32,31,31,31,32,32,32,32,31,31,31,31,32,32,31,31,31,31,31,32,32,32,31,31,31,31,32,32,32,31,31,31,31,32,32,32,32,32,31,32,32,32,32,31,31,31,32,32,32,32,31,31,31,31,32,32,32,32,31,32,31,32,32,31,32,31,31,31,31,32,32,32,31,31,31,31,32,32,32,32,32,32,31,31,31,31,32,32,32,31,31,31,32,32,32,31,31,31,31,32,32,32,31,31,31,31,31,31,31,31,32,32,32,32,31,31,32,32,32,32,31,31,32,32,32,32,31,31,32,32,32,32,31,32,32,32,31,31,31,31,32,32,32,31,31,32,32,32,32,31,31,31,32,32,32,31,31,31,31,32,32,32,32,32,32,32,31,31,31,32,32,31,31,31,31,32,32,32,32,31,31,31,32,32,32,32,31,31,31,31,32,32,32,32,32,31,32,31,31,31,31,32,32,31,31,31,31,31,32,32,32,31,31,31,31,32,32,32,32,31,31,31,32,32,32,32,32,31,31,31,32,32,32,31,31,31,32,32,32,32,31,32,32,31,32,32,31,31,31,31,31,32,32,32,31,31,32,32,32,32,31,31,31,32,32,32,32,31,31,31,31,32,32,31,31,32,31,31,32,32,32,32,31,31,31,31,31,32,32,31,31,31,31,31,32,32,32,32,32,32,32,32,32,32,31,31,31,31,32,32,31,31,31,32,32,32,32,32,32,32,32,32,31,31,32,31,32,32,31,31,31,31,32,32,31,32,31,31,32,32,32,31,31,31,31,32,32,31,31,31,31,32,32,32,32,31,32,31,32,32,32,31,31,31,32,32,32,32,32,31,31,31,31,32,32,32,32,31,31,31,31,31,31,31,31,31,31,32,32,32,31,31,31,31,32,31,31,31,31,32,32,32,32,31,31,32,32,32,32,31,31,32,32,32,32,32,31,32,32,32,32,32,32,32,31,32,32,32,32,31,31,31,31,32,32,32,32,31,31,31,31,32,32,32,31,31,31,31,32,32,32,32,31,31,31,31,32,32,32,31,31,31,31,32,32,32,31,31,31,31,31,32,32,32,31,31,31,31,32,32,32,32,31,31,31,32,32,32,32,31,31,32,32,32,32,32,31,32,32,32,32,31,31,31,32,32,32,32,31,31,32,32,32,32,31,31,31,32,32,32,32,31,31,31,32,32,32,32,31,31,32,32,31,32,31,31,31,31,32,32,32,32,31,31,31,31,31,32,31,31,31,31,32,32,31,32,31,31,32,32,32,32,31,32,31,32,32,32,31,31,31,31,32,31,31,31,31,32,32,32,32,31,31,31,32,32,32,31,31,31,32,32,32,32,31,31,31,31,32,32,32,32,31,31,31,31,32,32,31,32,31,32,32,32,32,32,32,32,32,32,31,31,31,32,32,32,32,31,31,31,31,32,32,32,32,31,31,31,31,31,31,31,31,31,31,32,31,31,31,31,31,32,32,32,31,31,31,31,32,32,31,31,31,32,32,32,32,31,31,31,32,32,31,31,31,31,32,32,32,31,31,31,32,32,32,32,32,32,31,32,32,32,32,32,32,32,32,32,32,32,32,32,32,31,31,31,32,32,32,32,31,31,31,31,31,31,31,31,31,31,32,32,31,31,31,31,32,32,32,32,31,31,32,32,31,31,31,31,32,32,32,32,31,31,31,31,32,31,31,31,31,32,32,32,32,31,31,31,31,32,32,31,31,31,31,31,31,31,31,31,31,32,32,32,32,32,31,31,31,32,32,32,31,31,31,32,32,32,32,31,31,32,32,32,32,31,31,31,31,32,32,32,31,32,31,31,32,31,32,31,31,32,31,32,32,32,32,32,32,31,31,31,31,32,32,32,31,31,31,31,32,32,32,32,31,31,31,31,32,32,31,31,31,31,32,32,31,32,31,32,32,32,32,31,31,32,32,32,32,31,31,32,32,32,31,31,31,32,32,32,31,32,32,32,32,32,32,32,31,32,32,32,32,32,32,32,32,32,31,31,32,32,32,32,31,31,31,31,32,31,31,31,31,31,31,32,32,32,31,31,31,31,31,31,31,31,31,31,32,31,31,31,31,31};

typedef struct {
	unsigned char *wave;
	uint32_t length;
}	soundt;
	
soundt sounds[1] = {
	{rowclear, rowclearLen}
};

void Sound_Init(void){
	NVIC_ST_CTRL_R = 0;
	NVIC_ST_CURRENT_R = 0;
	NVIC_SYS_PRI3_R = (NVIC_SYS_PRI3_R&0x00FFFFFF)|0x20000000;
	
	DAC_Init(); 
};

//Also do #include Timer1.h since you're using that

void Timer1A_Stop(void); //This creates a Timer1A_Stop function that does nothing.
//Edit Timer1 file and include this function in the .h file as well.

uint32_t pIndex;

void playsample(void){
	DAC_Out(sounds[sound2play].wave[pIndex++]);
	if (pIndex >= sounds[sound2play].length){
		Timer1A_Stop();
		pIndex = 0;
	}
}

void Timer1_Init(void(*task)(void), uint32_t period); //Same thing with the Timer1A_Stop function.
// Needs to include Timer1.h function

void playsound(enum sound sound){ //Did enumerate because of how sound is, sounds[1] is an array, so i made sound an index.
	//I rewrote this function and its declaration in the Sound.h to be similar to how TexasMode works (SCOPE, LOGICANALYZER, etc)
	sound2play = sound;
	Timer1_Init(&playsample, BusClock/SampleFreq);
}
